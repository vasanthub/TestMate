      
            
<div class="test-container" *ngIf="!loading && testStarted">
  <div class="repository">
    {{topic}}>{{repository}}
  </div>
  <div *ngIf="!showResult" class="test-layout">
    <!-- Main Question Area -->
    <div class="question-area">
      <div class="question-header">
        <div class="question-number">
          Question {{ currentIndex + 1 }} of {{ questions.length }}
        </div>
        <div class="header-actions">
          <span class="clipboard-label">{{ClipboardCopyStatus}}</span>

          <button class="btn-icon" 
        (click)="openMoveQuestionDialog()" 
        title="Move question to another repository">
          üì¶
        </button>

        <button class="btn-icon btn-icon-danger" 
        (click)="openDeleteQuestionDialog()" 
        title="Delete question">
          üóëÔ∏è
        </button>
          
          <button class="btn-icon" (click)="copyQuestionToClipboard()" title="Copy question">
            üìë           
          </button>
         
          <button class="btn-icon" (click)="uploadImageFromClipboard(domain, topic, repository, currentIndex, 1, $event)"  title="Image Upload">
            üìÅ1
          </button>
          <button class="btn-icon" (click)="uploadImageFromClipboard(domain, topic, repository, currentIndex, 2, $event)"  title="Image Upload">
            üìÅ2
          </button>
          <button class="btn-icon" (click)="uploadImageFromClipboard(domain, topic, repository, currentIndex, 3, $event)"  title="Image Upload">
            üìÅ3
          </button>
          <button class="btn-icon" (click)="uploadImageFromClipboard(domain, topic, repository, currentIndex, 4, $event)"  title="Image Upload">
            üìÅ4
          </button>
          <button class="btn-icon" (click)="toggleTimer()" title="Toggle timer">
            ‚è±Ô∏è
          </button>          
          <button class="btn btn-success" (click)="finishTest()">
          Finish Test
        </button>  
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="(currentIndex + 1) / questions.length * 100"></div>
        </div>        
      </div>

      <div class="question-content">
        <div class="question-text">
          <ng-container *ngFor="let line of (currentQuestion.question || '').split('\n')">
            <span [innerHTML]="renderLatex(line)"></span>
            <br>
          </ng-container>
        </div>
        
        <div *ngIf="currentQuestion.question_image" class="question-image">
          <img [src]="getQuestionImage(1)" alt="Question image">
        </div>

        <!-- Multiple Choice Options -->
        <div *ngIf="isMultipleChoice" class="options">
          <div *ngFor="let option of currentQuestion.options; let i = index" 
               class="option"
               [class.selected]="selectedOptions[i] && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt'"
               [class.correct-answer]="showFeedback && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt' && isCorrectOption(i)"
               [class.wrong-answer]="showFeedback && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt' && selectedOptions[i] && !isCorrectOption(i)">
            
            <label *ngIf="isSingleAnswer" class="option-label">
              <input 
                type="radio" 
                [name]="'question-' + currentIndex"
                [checked]="selectedOptions[i] && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt'"
                [disabled]="isAnswerSubmitted && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt'"
                (change)="onOptionChange(i)">
              <span class="option-content">
                <span class="option-text" [innerHTML]="renderLatex(option)"></span>
                <img *ngIf="currentQuestion.options_image && currentQuestion.options_image[i]" 
                     [src]="currentQuestion.options_image[i]" 
                     class="option-image" 
                     alt="Option image">
              </span>
            </label>

            <label *ngIf="isMultipleAnswer" class="option-label">
              <input 
                type="checkbox" 
                [disabled]="isAnswerSubmitted && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt'"
                [(ngModel)]="selectedOptions[i]">
              <span class="option-content">
                <span class="option-text" [innerHTML]="renderLatex(option)"></span>
                <img *ngIf="currentQuestion.options_image && currentQuestion.options_image[i]" 
                     [src]="currentQuestion.options_image[i]" 
                     class="option-image" 
                     alt="Option image">
              </span>
            </label>
            
            
        </div>

      </div>

      
          <div *ngIf="isAnswerSubmitted && !isTextAnswer && currentQuestion.answer_image" class="correct-text-answer">            
            <strong>Diagram:</strong> 
            <div *ngIf="currentQuestion.answer_image" class="question-image">
              <img [src]="getQuestionImage(3)" alt="Answer image">
            </div>
          </div>

        <!-- Text Answer -->
        <div *ngIf="isTextAnswer" class="text-answer">
          <textarea *ngIf="!isTextAnswer"
            #answerInput
            [(ngModel)]="textAnswer"
            [disabled]="isAnswerSubmitted && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt'"
            placeholder="Enter your answer here..."
            rows="4"></textarea>
          <p *ngIf="currentQuestion.answerRegex && !isTextAnswer" class="hint">
            <svg class="hint-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Answer will be validated using pattern matching
          </p>
          
          <!-- Text Answer Action Buttons - Always visible before submission -->
          <div *ngIf="!isAnswerSubmitted ||  getQuestionStatus(currentIndex) === 'incorrectPreviousAttempt'" class="text-answer-actions">
            <button class="btn btn-warning btn-sm" (click)="revealAnswer()" *ngIf="!showFeedback || getQuestionStatus(currentIndex) === 'incorrectPreviousAttempt'">
              <svg class="btn-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/>
                <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/>
              </svg>
              Reveal Answer
            </button>            
          </div>


          <div *ngIf="showFeedback" class="correct-text-answer">            
            <strong>Correct Answer:</strong> 
            <div *ngIf="currentQuestion.answer_image" class="question-image">
              <img [src]="getQuestionImage(3)" alt="Answer image">
            </div>
            <div>
              <ng-container *ngFor="let line of (currentQuestion.answerText || '').split('\n')">
                <span [innerHTML]="renderLatex(line)"></span>
                <br>
              </ng-container>
            </div>
          </div>

          <!-- Manual marking buttons after reveal -->
          <div *ngIf="showFeedback && !isAnswerSubmitted" class="text-answer-actions">
            <button class="btn btn-success btn-sm" (click)="markAsCorrect()">
              <svg class="btn-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M5 13l4 4L19 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Mark as Correct
            </button>
            <button class="btn btn-error btn-sm" (click)="markAsIncorrect()">
              <svg class="btn-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Mark as Incorrect
            </button>
          </div>

         
        </div>
      <!-- Answer Feedback -->
      <div *ngIf="showFeedback && isCurrentAnswerCorrect" class="answer-feedback-text">
        ‚úì Correct!
      </div>

      <div class="question-actions">
        <button *ngIf="!isTextAnswer && (getQuestionStatus(currentIndex) === 'incorrectPreviousAttempt' || !isAnswerSubmitted)" class="btn btn-primary btn-submit" (click)="submitAnswer()">
          Submit Answer          
        </button>
        <button *ngIf="getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt' && (isAnswerSubmitted && !isCurrentAnswerCorrect)" class="btn btn-primary btn-got-it" (click)="nextQuestion()">
          Got It ‚Üí          
        </button>
        <button class="btn btn-secondary" (click)="previousQuestion()" [disabled]="currentIndex === 0">
          ‚Üê Previous
        </button>
        <button class="btn btn-secondary" (click)="nextQuestion()" [disabled]="currentIndex === questions.length - 1">
          Next ‚Üí
        </button>

      </div>
       <div *ngIf="showFeedback && getQuestionStatus(currentIndex) !== 'incorrectPreviousAttempt' && currentQuestion.explanation" class="correct-text-answer">
            <strong>Explanation:</strong> 
            <div>
              <ng-container *ngFor="let line of currentQuestion.explanation.split('\n')">
                <span [innerHTML]="renderLatex(line)"></span>
                <br>
              </ng-container>
            </div>
          </div>
    </div>

    <!-- Right Panel -->
    <div class="info-panel">
      <div class="timer-card card" *ngIf="showTimer">
        <svg class="timer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="timer-text" #timerText></div>
      </div>

      <!-- <div class="stats-card card">
        <div class="stat-item">
          <span class="stat-label">Total Questions:</span>
          <span class="stat-value">{{ questions.length }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Answered:</span>
          <span class="stat-value">{{ answeredCount }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Remaining:</span>
          <span class="stat-value">{{ questions.length - answeredCount }}</span>
        </div>
      </div> -->

      <div class="questions-grid card">
        <div class="grid-header">Questions</div>
        <div class="grid-items">
          <button 
            *ngFor="let q of questions; let i = index"
            class="question-box"
            [class.current]="i === currentIndex"
            [class.correct]="getQuestionStatus(i) === 'correct'"
            [class.incorrect]="getQuestionStatus(i) === 'incorrect' || getQuestionStatus(i) === 'incorrectPreviousAttempt'"
            [class.unanswered]="getQuestionStatus(i) === 'unanswered'"
            (click)="goToQuestion(i)">
            {{ i + 1 }}
          </button>
        </div>
      </div>
    </div>
  </div>  
</div>

<!-- Result Screen -->
  <div *ngIf="showResult" class="result-screen">
    <div class="result-card card">
      <div class="result-icon">
        <svg *ngIf="finalScore >= 70" class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <svg *ngIf="finalScore < 70" class="warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <h1 class="result-title">{{ isPractice ? 'Practice' : 'Test' }} Complete!</h1>
      
      <div class="score-display">
        <div class="score-circle">
          <span class="score-number">{{ finalScore }}%</span>
        </div>
      </div>

      <div class="result-stats">
        <div class="result-stat">
          <span class="result-stat-value">{{ answeredCount }}</span>
          <span class="result-stat-label">Answered</span>
        </div>
        <div class="result-stat">
          <span class="result-stat-value">{{ correctCount }}</span>
          <span class="result-stat-label">Correct</span>
        </div>
        <div class="result-stat">
          <span class="result-stat-value">{{ incorrectCount }}</span>
          <span class="result-stat-label">Incorrect</span>
        </div>
        <div class="result-stat">
          <span class="result-stat-value">{{ skippedCount }}</span>
          <span class="result-stat-label">Skipped</span>
        </div>
      </div>

      <div class="result-actions">
        <!-- <button class="btn btn-primary" (click)="retakeFull()">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Retake Full Test
        </button>
        <button *ngIf="incorrectCount > 0" 
                class="btn btn-warning" 
                (click)="retakeIncorrect()">
          Retry Incorrect
        </button>
        <button *ngIf="skippedCount > 0" 
                class="btn btn-secondary" 
                (click)="retakeSkipped()">
          Retry Skipped
        </button>
        <button *ngIf="!isPractice" class="btn btn-secondary" (click)="viewResults()">
          View All Results
        </button> -->
        <button class="btn btn-secondary" (click)="goHome()">
          Back to Home
        </button>
      </div>
    </div>
  </div>

  <!-- Move Question Dialog -->
<div *ngIf="showMoveQuestionDialog" class="modal-overlay" (click)="closeMoveQuestionDialog()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Move Question to Repository</h2>
      <button class="btn-close" (click)="closeMoveQuestionDialog()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="current-question-info">
        <p><strong>Current Repository:</strong> {{ repository }}</p>
        <p><strong>Question {{ currentIndex + 1 }} of {{ questions.length }}</strong></p>
        <div class="question-preview">
          {{ currentQuestion.question.substring(0, 100) }}{{ currentQuestion.question.length > 100 ? '...' : '' }}
        </div>
      </div>

      <div class="repository-selection">
        <label for="targetRepository">Select Target Repository:</label>
        <select 
          id="targetRepository" 
          [(ngModel)]="selectedTargetRepository"
          class="repository-select"
          [disabled]="isMovingQuestion">
          <option value="">-- Choose a repository --</option>
          <option *ngFor="let repo of availableRepositories" [value]="repo">
            {{ repo }}
          </option>
        </select>
      </div>

      <div class="warning-message">
        <svg class="warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p>Warning: This action cannot be undone. The question will be removed from the current repository and added to the target repository.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button 
        class="btn btn-secondary" 
        (click)="closeMoveQuestionDialog()"
        [disabled]="isMovingQuestion">
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="moveCurrentQuestion()"
        [disabled]="!selectedTargetRepository || isMovingQuestion">
        <span *ngIf="!isMovingQuestion">Move Question</span>
        <span *ngIf="isMovingQuestion">Moving...</span>
      </button>
    </div>
  </div>
</div>

<!-- Delete Question Dialog -->
<div *ngIf="showDeleteQuestionDialog" class="modal-overlay" (click)="closeDeleteQuestionDialog()">
  <div class="modal-dialog modal-dialog-danger" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Delete Question</h2>
      <button class="btn-close" (click)="closeDeleteQuestionDialog()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="current-question-info danger-info">
        <p><strong>Repository:</strong> {{ repository }}</p>
        <p><strong>Question {{ currentIndex + 1 }} of {{ questions.length }}</strong></p>
        <div class="question-preview">
          {{ currentQuestion.question.substring(0, 150) }}{{ currentQuestion.question.length > 150 ? '...' : '' }}
        </div>
      </div>

      <div class="danger-message">
        <svg class="danger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <p class="danger-title">‚ö†Ô∏è PERMANENT ACTION</p>
          <p>This action CANNOT be undone! The question will be permanently removed from the repository JSON file.</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button 
        class="btn btn-secondary" 
        (click)="closeDeleteQuestionDialog()"
        [disabled]="isDeletingQuestion">
        Cancel
      </button>
      <button 
        class="btn btn-danger" 
        (click)="deleteCurrentQuestion()"
        [disabled]="isDeletingQuestion">
        <span *ngIf="!isDeletingQuestion">üóëÔ∏è Delete Question</span>
        <span *ngIf="isDeletingQuestion">Deleting...</span>
      </button>
    </div>
  </div>
</div>

<div *ngIf="loading" class="loading">
  <div class="spinner"></div>
  <p>Loading test...</p>
</div>